(self.webpackChunkgordan404wiki=self.webpackChunkgordan404wiki||[]).push([[1978],{230:(n,s,a)=>{"use strict";a.r(s),a.d(s,{data:()=>t});const t={key:"v-4c542219",path:"/vueAnalysis/reactive/nexttick.html",title:"nextTick实现原理",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"异步知识",slug:"异步知识",children:[{level:3,title:"Event Loop",slug:"event-loop",children:[]},{level:3,title:"MutationObserver",slug:"mutationobserver",children:[]},{level:3,title:"setImmediate和setTimeout",slug:"setimmediate和settimeout",children:[]}]},{level:2,title:"nextTick实现",slug:"nexttick实现",children:[]}],filePathRelative:"vueAnalysis/reactive/nexttick.md",git:{updatedTime:1626972344e3,contributors:[{name:"lishuaixingNewBee",email:"vae.china@foxmail.com",commits:1}]}}},8114:(n,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>un});var t=a(4057),e=a(3197);const o=(0,t.Wm)("h1",{id:"nexttick实现原理",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#nexttick实现原理","aria-hidden":"true"},"#"),(0,t.Uk)(" nextTick实现原理")],-1),c=(0,t.Wm)("p",null,[(0,t.Uk)("在使用"),(0,t.Wm)("code",null,"Vue.js"),(0,t.Uk)("开发的时候，如果我们要根据数据状态操作正确的"),(0,t.Wm)("code",null,"DOM"),(0,t.Uk)("，那么我们一定和"),(0,t.Wm)("code",null,"nextTick()"),(0,t.Uk)("方法打过交道，它是"),(0,t.Wm)("code",null,"Vue.js"),(0,t.Uk)("中一个比较核心的一个方法，在这一章节中我们来介绍"),(0,t.Wm)("code",null,"Vue.js"),(0,t.Uk)("中"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("是如何实现的。")],-1),k=(0,t.Wm)("h2",{id:"异步知识",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#异步知识","aria-hidden":"true"},"#"),(0,t.Uk)(" 异步知识")],-1),l=(0,t.Wm)("p",null,[(0,t.Uk)("由于"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("涉及到许多与异步相关联的知识，因此为了降低学习难度，我们先来介绍这些异步知识。")],-1),p=(0,t.Wm)("h3",{id:"event-loop",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#event-loop","aria-hidden":"true"},"#"),(0,t.Uk)(" Event Loop")],-1),u=(0,t.Wm)("p",null,[(0,t.Uk)("我们都知道"),(0,t.Wm)("code",null,"JavaScript"),(0,t.Uk)("是单线程的，它是基于"),(0,t.Wm)("code",null,"Event Loop"),(0,t.Uk)("事件循环来执行的，"),(0,t.Wm)("code",null,"Event Loop"),(0,t.Uk)("在执行的时候遵循一定的规则：所有同步任务都在主线程中执行，形成一个"),(0,t.Wm)("strong",null,"执行栈"),(0,t.Uk)("，所有异步任务，都会被暂时放入一个"),(0,t.Wm)("strong",null,"任务队列"),(0,t.Uk)("中，当所有同步任务执行完毕时，会读取这个任务队列让其进入执行栈，开始执行。以上介绍属于一次执行机制，主线程不断重复这个过程就形成了"),(0,t.Wm)("code",null,"Event Loop"),(0,t.Uk)("事件循环。")],-1),m=(0,t.Wm)("p",null,[(0,t.Uk)("以上是对"),(0,t.Wm)("code",null,"Event Loop"),(0,t.Uk)("的大体介绍，但在"),(0,t.Wm)("code",null,"Event Loop"),(0,t.Uk)("执行的时候，还有一些细节需要我们去掌握。")],-1),i=(0,t.Wm)("p",null,[(0,t.Uk)("我们在派发更新章节提到过"),(0,t.Wm)("code",null,"tick"),(0,t.Uk)("，那么什么是"),(0,t.Wm)("code",null,"tick"),(0,t.Uk)("？"),(0,t.Wm)("code",null,"tick"),(0,t.Uk)("就是主线程的一次执行过程。所有异步任务都是通过任务队列来调度的，任务队列中存放的是一个个任务("),(0,t.Wm)("code",null,"task"),(0,t.Uk)(")，而这一个个"),(0,t.Wm)("code",null,"task"),(0,t.Uk)("按照规范，又分为"),(0,t.Wm)("code",null,"macro task"),(0,t.Uk)("宏任务和"),(0,t.Wm)("code",null,"micro task"),(0,t.Uk)("微任务。"),(0,t.Wm)("code",null,"macro task"),(0,t.Uk)("和"),(0,t.Wm)("code",null,"micro task"),(0,t.Uk)("在执行的时候存在一个微妙的关系：每个"),(0,t.Wm)("code",null,"macro task"),(0,t.Uk)("执行结束后，会清空所有的"),(0,t.Wm)("code",null,"micro task"),(0,t.Uk)("。")],-1),W=(0,t.Wm)("p",null,[(0,t.Uk)("在浏览器环境下，"),(0,t.Wm)("code",null,"macro task"),(0,t.Uk)("和"),(0,t.Wm)("code",null,"micro task"),(0,t.Uk)("对应如下：")],-1),r=(0,t.Wm)("ul",null,[(0,t.Wm)("li",null,[(0,t.Wm)("code",null,"macro task"),(0,t.Uk)("宏任务："),(0,t.Wm)("code",null,"MessageChannel"),(0,t.Uk)("、"),(0,t.Wm)("code",null,"postMessage"),(0,t.Uk)("、"),(0,t.Wm)("code",null,"setImmediate"),(0,t.Uk)("和"),(0,t.Wm)("code",null,"setTimeout"),(0,t.Uk)("。")]),(0,t.Wm)("li",null,[(0,t.Wm)("code",null,"micro task"),(0,t.Uk)("微任务："),(0,t.Wm)("code",null,"Promise.then"),(0,t.Uk)("和"),(0,t.Wm)("code",null,"MutationObsever"),(0,t.Uk)("。")])],-1),U=(0,t.Wm)("p",null,[(0,t.Wm)("img",{src:e.Z,alt:"Event Loop"})],-1),d=(0,t.Wm)("h3",{id:"mutationobserver",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#mutationobserver","aria-hidden":"true"},"#"),(0,t.Uk)(" MutationObserver")],-1),b=(0,t.Uk)("在"),v={href:"https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver",target:"_blank",rel:"noopener noreferrer"},f=(0,t.Uk)("MDN文档"),h=(0,t.Uk)("中，我们可以看到"),g=(0,t.Wm)("code",null,"MutationObserver",-1),w=(0,t.Uk)("的详细用法，它不是很复杂，它的作用是：创建并返回一个新的 "),x=(0,t.Wm)("code",null,"MutationObserver",-1),y=(0,t.Uk)("实例，它会在指定的DOM发生变化时被调用。"),T=(0,t.Wm)("p",null,"我们按照文档介绍，来撰写一个例子：",-1),O=(0,t.Wm)("div",{class:"language-javascript ext-js"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function-variable function"},"callback"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  console"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"log"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'text node data change'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" observer "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"MutationObserver"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("callback"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" count "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" textNode "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" document"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"createTextNode"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("count"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\nobserver"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"observe"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("textNode"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  characterData"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"func"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  count"),(0,t.Wm)("span",{class:"token operator"},"++"),(0,t.Uk)("\n  textNode"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("data "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" count\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token function"},"func"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token comment"},"// text node data change"),(0,t.Uk)("\n")])])],-1),M=(0,t.Wm)("p",null,"代码分析：",-1),I=(0,t.Wm)("ul",null,[(0,t.Wm)("li",null,[(0,t.Uk)("首先定义了"),(0,t.Wm)("code",null,"callback"),(0,t.Uk)("回调函数和"),(0,t.Wm)("code",null,"MutationObserver"),(0,t.Uk)("的实例对象，其中构造函数传递的参数是我们的"),(0,t.Wm)("code",null,"callback"),(0,t.Uk)("。")]),(0,t.Wm)("li",null,[(0,t.Uk)("然后创建一个文本节点并传入文本节点的初始文本，接着调用"),(0,t.Wm)("code",null,"MutationObserver"),(0,t.Uk)("实例的"),(0,t.Wm)("code",null,"observe"),(0,t.Uk)("方法，传入我们创建的文本节点和一个"),(0,t.Wm)("code",null,"config"),(0,t.Uk)("观察配置对象，其中"),(0,t.Wm)("code",null,"characterData:true"),(0,t.Uk)("的意思是：我们要观察"),(0,t.Wm)("code",null,"textNode"),(0,t.Uk)("节点的文本变动。"),(0,t.Wm)("code",null,"config"),(0,t.Uk)("还有其他选项属性，你可以在"),(0,t.Wm)("code",null,"MDN"),(0,t.Uk)("文档中查看到。")]),(0,t.Wm)("li",null,[(0,t.Uk)("接着，我们定义一个"),(0,t.Wm)("code",null,"func"),(0,t.Uk)("函数，这个函数主要做的事情就是修改"),(0,t.Wm)("code",null,"textNode"),(0,t.Uk)("文本节点中的文本内容，当文本内容变动后，"),(0,t.Wm)("code",null,"callback"),(0,t.Uk)("会自动被调用，因此输出"),(0,t.Wm)("code",null,"text node data change"),(0,t.Uk)("。")])],-1),j=(0,t.Wm)("p",null,[(0,t.Uk)("在了解了"),(0,t.Wm)("code",null,"MutationObserver"),(0,t.Uk)("的用法后，我们来看一下"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("方法中，是如何使用"),(0,t.Wm)("code",null,"MutationObserver"),(0,t.Uk)("的：")],-1),N=(0,t.Wm)("div",{class:"language-javascript ext-js"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"import"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" isIE"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" isNative "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"from"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'./env'"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token comment"},"// 省略代码"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token operator"},"!"),(0,t.Uk)("isIE "),(0,t.Wm)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" MutationObserver "),(0,t.Wm)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'undefined'"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function"},"isNative"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("MutationObserver"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"||"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// PhantomJS and iOS 7.x"),(0,t.Uk)("\n  MutationObserver"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"toString"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'[object MutationObserverConstructor]'"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// Use MutationObserver where native Promise is not available,"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// e.g. PhantomJS, iOS7, Android 4.4"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// (#6466 MutationObserver is unreliable in IE11)"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" counter "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" observer "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"MutationObserver"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("flushCallbacks"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" textNode "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" document"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"createTextNode"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"String"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("counter"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  observer"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"observe"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("textNode"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    characterData"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function-variable function"},"timerFunc"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    counter "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("counter "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"%"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Uk)("\n    textNode"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("data "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"String"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("counter"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  isUsingMicroTask "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])])],-1),E=(0,t.uE)("我们可以看到，<code>nextTick</code>中首先判断了非<code>IE</code>浏览器并且<code>MutationObserver</code>可用且为原生<code>MutationObserver</code>时才会使用<code>MutationObserver</code>。对于判断非<code>IE</code>浏览器的情况，你可以看<code>Vue.js</code>的<code>issue</code>",16),P={href:"https://github.com/vuejs/vue/issues/6466",target:"_blank",rel:"noopener noreferrer"},S=(0,t.Uk)("#6466"),C=(0,t.Uk)("来查看原因。"),F=(0,t.Wm)("h3",{id:"setimmediate和settimeout",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#setimmediate和settimeout","aria-hidden":"true"},"#"),(0,t.Uk)(" setImmediate和setTimeout")],-1),L=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"setTimeout"),(0,t.Uk)("对于大部分人来说是非常常见的一个定时器方法，因此我们不做过多的介绍。")],-1),D=(0,t.Uk)("在"),_=(0,t.Wm)("code",null,"nextTick",-1),A=(0,t.Uk)("方法实现中，它使用到了"),V=(0,t.Wm)("code",null,"setImmediate",-1),q=(0,t.Uk)("，我们在"),J={href:"https://www.caniuse.com/?search=setImmediate",target:"_blank",rel:"noopener noreferrer"},$=(0,t.Uk)("Can I Use"),z=(0,t.Uk)("网站上可以发现，这个"),Z=(0,t.Wm)("code",null,"API",-1),B=(0,t.Uk)("方法只存在于高版本"),H=(0,t.Wm)("code",null,"IE",-1),R=(0,t.Uk)("浏览器和低版本"),Y=(0,t.Wm)("code",null,"Edge",-1),G=(0,t.Uk)("浏览器中，其它浏览器不支持。"),K=(0,t.Wm)("p",null,[(0,t.Uk)("那么为什么会使用这个方法呢，这是因为我们之前提到的一个"),(0,t.Wm)("code",null,"issue"),(0,t.Uk)("："),(0,t.Wm)("code",null,"MutationObserver"),(0,t.Uk)("在"),(0,t.Wm)("code",null,"IE"),(0,t.Uk)("浏览器中并不可靠，因此在"),(0,t.Wm)("code",null,"IE"),(0,t.Uk)("浏览器下降级到使用"),(0,t.Wm)("code",null,"setImmediate"),(0,t.Uk)("，我们可以把"),(0,t.Wm)("code",null,"setImmediate"),(0,t.Uk)("看做和"),(0,t.Wm)("code",null,"setTimeout"),(0,t.Uk)("一样。")],-1),Q=(0,t.Wm)("div",{class:"language-javascript ext-js"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token function"},"setImmediate"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  console"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"log"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'setImmediate'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"// 约等于"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token function"},"setTimeout"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  console"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"log"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'setTimeout'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])])],-1),X=(0,t.Wm)("h2",{id:"nexttick实现",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#nexttick实现","aria-hidden":"true"},"#"),(0,t.Uk)(" nextTick实现")],-1),nn=(0,t.Wm)("p",null,[(0,t.Uk)("介绍完"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("与异步相关的知识后，我们来的分析一下"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("方法的实现，首先要说的是："),(0,t.Wm)("strong",null,"异步降级"),(0,t.Uk)("。")],-1),sn=(0,t.Wm)("div",{class:"language-javascript ext-js"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" timerFunc\n\n"),(0,t.Wm)("span",{class:"token comment"},"// The nextTick behavior leverages the microtask queue, which can be accessed"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"// via either native Promise.then or MutationObserver."),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"// MutationObserver has wider support, however it is seriously bugged in"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"// UIWebView in iOS >= 9.3.3 when triggered in touch event handlers. It"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"// completely stops working after triggering a few times... so, if native"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"// Promise is available, we will use it:"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"/* istanbul ignore next, $flow-disable-line */"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" Promise "),(0,t.Wm)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'undefined'"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"isNative"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("Promise"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" p "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" Promise"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"resolve"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function-variable function"},"timerFunc"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    p"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"then"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("flushCallbacks"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// In problematic UIWebViews, Promise.then doesn't completely break, but"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// it can get stuck in a weird state where callbacks are pushed into the"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// microtask queue but the queue isn't being flushed, until the browser"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// needs to do some other work, e.g. handle a timer. Therefore we can"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},'// "force" the microtask queue to be flushed by adding an empty timer.'),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("isIOS"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"setTimeout"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("noop"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  isUsingMicroTask "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token operator"},"!"),(0,t.Uk)("isIE "),(0,t.Wm)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" MutationObserver "),(0,t.Wm)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'undefined'"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function"},"isNative"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("MutationObserver"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"||"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// PhantomJS and iOS 7.x"),(0,t.Uk)("\n  MutationObserver"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"toString"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'[object MutationObserverConstructor]'"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// Use MutationObserver where native Promise is not available,"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// e.g. PhantomJS, iOS7, Android 4.4"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// (#6466 MutationObserver is unreliable in IE11)"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" counter "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" observer "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"MutationObserver"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("flushCallbacks"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" textNode "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" document"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"createTextNode"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"String"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("counter"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  observer"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"observe"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("textNode"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    characterData"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function-variable function"},"timerFunc"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    counter "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("counter "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"%"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Uk)("\n    textNode"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("data "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"String"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("counter"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  isUsingMicroTask "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" setImmediate "),(0,t.Wm)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'undefined'"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"isNative"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("setImmediate"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// Fallback to setImmediate."),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// Technically it leverages the (macro) task queue,"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// but it is still a better choice than setTimeout."),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function-variable function"},"timerFunc"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token function"},"setImmediate"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("flushCallbacks"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// Fallback to setTimeout."),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function-variable function"},"timerFunc"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token function"},"setTimeout"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("flushCallbacks"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])])],-1),an=(0,t.Wm)("p",null,[(0,t.Uk)("我们在前面介绍过"),(0,t.Wm)("code",null,"Event Loop"),(0,t.Uk)("事件循环，由于"),(0,t.Wm)("code",null,"macro task"),(0,t.Uk)("和"),(0,t.Wm)("code",null,"micro task"),(0,t.Uk)("特殊的执行机制，我们首先判断当前浏览器是否支持"),(0,t.Wm)("code",null,"Promise"),(0,t.Uk)("，如果不支持，则降级到判断是否支持"),(0,t.Wm)("code",null,"MutationObserver"),(0,t.Uk)("，如果还不支持，则继续降级到判断是否支持"),(0,t.Wm)("code",null,"setImmediate"),(0,t.Uk)("，最后降级使用"),(0,t.Wm)("code",null,"setTimeout"),(0,t.Uk)("。")],-1),tn=(0,t.Wm)("p",null,[(0,t.Uk)("在介绍完异步降级之后，我们来看"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("的实现代码：")],-1),en=(0,t.Wm)("div",{class:"language-javascript ext-js"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" callbacks "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" pending "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"export"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"nextTick"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token parameter"},[(0,t.Uk)("cb"),(0,t.Wm)("span",{class:"token operator"},"?"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(" Function"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ctx"),(0,t.Wm)("span",{class:"token operator"},"?"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(" Object")]),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" _resolve\n  callbacks"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"push"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("cb"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t.Wm)("span",{class:"token keyword"},"try"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token function"},"cb"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ctx"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"catch"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("e"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token function"},"handleError"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("e"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ctx"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'nextTick'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("_resolve"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t.Wm)("span",{class:"token function"},"_resolve"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ctx"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token operator"},"!"),(0,t.Uk)("pending"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    pending "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token function"},"timerFunc"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token comment"},"// $flow-disable-line"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token operator"},"!"),(0,t.Uk)("cb "),(0,t.Wm)("span",{class:"token operator"},"&&"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" Promise "),(0,t.Wm)("span",{class:"token operator"},"!=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'undefined'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"Promise"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token parameter"},"resolve"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      _resolve "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" resolve\n    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])])],-1),on=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("真正的代码并不复杂，首先会把传入的"),(0,t.Wm)("code",null,"cb"),(0,t.Uk)("收集起来，然后判断"),(0,t.Wm)("code",null,"pending"),(0,t.Uk)("为"),(0,t.Wm)("code",null,"false"),(0,t.Uk)("的时候开始执行"),(0,t.Wm)("code",null,"timerFunc"),(0,t.Uk)("方法，其中"),(0,t.Wm)("code",null,"timeFunc"),(0,t.Uk)("在异步降级的过程中被定义的。"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("方法在最后还进行了判断，如果没有传入"),(0,t.Wm)("code",null,"cb"),(0,t.Uk)("并且支持"),(0,t.Wm)("code",null,"Promise"),(0,t.Uk)("的话，它会返回一个"),(0,t.Wm)("code",null,"promise"),(0,t.Uk)("，因此我们在使用"),(0,t.Wm)("code",null,"nextTick"),(0,t.Uk)("的时候可以有两种使用方式：")],-1),cn=(0,t.Wm)("div",{class:"language-javascript ext-js"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function-variable function"},"callback"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  console"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"log"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'nextTick callback'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token comment"},"// 方式一"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"this"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"$nextTick"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("callback"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token comment"},"// 方式二"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"this"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"$nextTick"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"then"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token function"},"callback"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])])],-1),kn=(0,t.Wm)("p",null,[(0,t.Uk)("在最后，我们来看一个在之前没有提到的"),(0,t.Wm)("code",null,"flushCallbacks"),(0,t.Uk)("方法实现：")],-1),ln=(0,t.Wm)("div",{class:"language-javascript ext-js"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" callbacks "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" pending "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"flushCallbacks"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  pending "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"const"),(0,t.Uk)(" copies "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" callbacks"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"slice"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  callbacks"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("length "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token keyword"},"for"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"let"),(0,t.Uk)(" i "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i "),(0,t.Wm)("span",{class:"token operator"},"<"),(0,t.Uk)(" copies"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i"),(0,t.Wm)("span",{class:"token operator"},"++"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    copies"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Uk)("i"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])])],-1),pn=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"flushCallbacks"),(0,t.Uk)("方法的主要作用就是：将"),(0,t.Wm)("code",null,"pending"),(0,t.Uk)("状态还原为"),(0,t.Wm)("code",null,"false"),(0,t.Uk)("并且遍历"),(0,t.Wm)("code",null,"callbacks"),(0,t.Uk)("数组中的方法并执行。")],-1),un={render:function(n,s){const a=(0,t.up)("OutboundLink");return(0,t.wg)(),(0,t.j4)(t.HY,null,[o,c,k,l,p,u,m,i,W,r,U,d,(0,t.Wm)("p",null,[b,(0,t.Wm)("a",v,[f,(0,t.Wm)(a)]),h,g,w,x,y]),T,O,M,I,j,N,(0,t.Wm)("p",null,[E,(0,t.Wm)("a",P,[S,(0,t.Wm)(a)]),C]),F,L,(0,t.Wm)("p",null,[D,_,A,V,q,(0,t.Wm)("a",J,[$,(0,t.Wm)(a)]),z,Z,B,H,R,Y,G]),K,Q,X,nn,sn,an,tn,en,on,cn,kn,ln,pn],64)}}},3197:(n,s,a)=>{"use strict";a.d(s,{Z:()=>t});const t=a.p+"assets/img/6.b0791cd2.png"}}]);